<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>NFCReader</title>
        <link rel="stylesheet" href="style.css">
        <!--script src="script.js"></script-->
    </head>
    <body>
        <!-- page content -->
        <header>
            <div id="emse_logo"><img class="emse_logo" src="emse-blanc.png" /></div>
            <div id="page_title">
                <h1>NFC Reader</h1>
                <hr size="1" width="50%" color="white" />
                <h3>Projet téléalimentation capteur capacitif</h3>
            </div>
        </header>

        <div id="body">
            <!-- ================== Tutorial animation before 1st tag reading ===================-->
            <div id="place_phone_anim">
                <img class="smartphone_tilted" src="smartphone_tilted.png" />
                <img class="antenna_tilted" src="antenna_tilted.png" />
                <button id="scanButton">Requête permission NFC</button>
            </div>

            <!-- ================== Results and button after 1st tag reading ===================-->
            <div id="tag_result">
                <div id="buttons_scale">
                    <button id="button_tare">Tare</button><br/>
                    <button id="button_5kg">5 kg</button>
                    <form id="sensibilite_form" style="text-align: center;">
                        <label for="sensibilite">Sensibilité : </label>
                        <input id="sensibilite" type="text" size="10" placeholder="0.0004768" value="0.0004768" />
                    </form>
                </div>
                <div id="results">
                    <span>Masse :</span>
                    <p id="weight">0 kg</p>
                    <span id="device_id">Device ID : ...</span><br/>
                    <span id="log">Logger...</span>
                </div>
            </div>
            <!-- ================== ======================================= ===================-->
        </div>

        <footer>Page créée pour des besoins de démonstration - Projet d'étude EMSE ISMIN 2022 - Pierre Merrien & Hugo Perrin - Sous la supervision et avec l'aide de Valentin Divay</footer>
    </body>
    <script>
        document.getElementById("place_phone_anim").hidden = false;
        document.getElementById("tag_result").hidden = true;

        var suspendNFC = false;

        var sensor_value = 8770150; // bit
        var tare = 8680000; // bit
        var sensibility = 0.0004768; // bit/N
        var mass = 0; // kg
        var gravity = 9.81; // N/kg

        if ('NDEFReader' in window) {

            // Check NFC feature permission in browser
            navigator.permissions.query({ name: "nfc" }).then((nfcStatus) => {
                // NFC already enabled
                if (nfcStatus.state === "granted") {
                    document.getElementById("scanButton").hidden = true;
                    startScanning();
                } else {
                // NFC not yet enabled, wait for user to click on button to ask for permission by trying to read tag
                document.querySelector("#scanButton").onclick = event => {
                    startScanning();
                };

                }
            });

            async function startScanning(){
                const ndef = new NDEFReader();

                

                ndef.scan().then(() => {
                    ndef.onreadingerror = () => {
                        // Could not scan a tag, try another
                        document.getElementById("log").innerHTML = "Tag read error !";
                    };

                    ndef.onreading = event => {
                        // A tag was read
                        if (suspendNFC == true) {
                            document.getElementById("log").innerHTML = "Can only scan when page visible !";    
                        } else {
                            // Handle showing results
                            handleResults(event);
                        }
                    };
                }).catch(error => {
                    /// Something wrong with hardware
                    document.getElementById("log").innerHTML = "Hardware error !";
                });
            }

            function handleResults(event) {
                // Hide tutorial animation if not done already
                document.getElementById("place_phone_anim").hidden = true;
                document.getElementById("tag_result").hidden = false;

                document.getElementById("device_id").innerHTML = "Device ID : " + event.serialNumber;

                // =====================================================================================================================
                // ===================================== DEAL WITH THE MESSAGES RECEIVED FROM THE TAG ==================================
                const message = event.message;
                for (const record of message.records) {

                    // Write read messages on the html page

                    //document.getElementById("messages").innerHTML += "</br>" + record.data + " ; " + record.data.byteLength + "</br>";
                    
                    // Write plaintext ASCII message
                    /*for( let i = 0 ; i < record.data.buffer.byteLength ; i++) {
                        document.getElementById("messages").innerHTML += String.fromCharCode(record.data.getUint8(i));
                    }*/
                    //document.getElementById("messages").innerHTML += " : ";

                    document.getElementById("log").innerHTML = "";

                    //document.getElementById("log").innerHTML = "Reading tag...";
                    
                    // Read sensor value from received ndef message 
                    sensor_value = 0;
                    for( let i = 0 ; i < record.data.buffer.byteLength ; i++) {
                        sensor_value = sensor_value << 8;
                        sensor_value += record.data.getUint8(i);

                        document.getElementById("log").innerHTML += record.data.getUint8(i).toString(16) + " ";
                    }
                    
                    // Compute mass
                    mass = (sensor_value - tare) * sensibility / gravity;
                    mass = Math.round(mass*1000)/1000;
                    
                    // show mass in kg on page
                    document.getElementById("weight").innerHTML = mass.toString(10) + " kg";
                }
                // =====================================================================================================================
                // =====================================================================================================================
            }
        }

        // Function called every 500 ms to update the mass according to last sensibility and tare (even if no new sensor value)
        async function virtual_sensor_read() {
            // Compute mass
            mass = (sensor_value - tare) * sensibility / gravity;
            mass = Math.round(mass*1000)/1000;
            
            // show mass in kg on page
            document.getElementById("weight").innerHTML = mass.toString(10) + " kg";

            setTimeout(virtual_sensor_read, 500);
        }

        setTimeout(virtual_sensor_read, 500);

        // Sensibility updated according to user input
        document.querySelector("#sensibilite").onchange = event => {
            sensibility = document.querySelector("#sensibilite").value;
        }
        document.querySelector("#sensibilite").onkeypress = "this.onchange();"
        document.querySelector("#sensibilite").onpaste    = "this.onchange();"
        document.querySelector("#sensibilite").oninput    = "this.onchange();"

        // Tare with last sensor_value
        document.querySelector("#button_tare").onclick = event => {
            tare = sensor_value;
        }

        // Change sensibility according to last sensor value and tare
        document.querySelector("#button_5kg").onclick = event => {
            if(sensor_value - tare != 0) {
                sensibility = 5 * gravity / (sensor_value - tare);
                sensibility = Math.round(sensibility*10000000)/10000000;

                document.querySelector("#sensibilite").value = sensibility.toString(10);
            } else {
                document.getElementById("log").innerHTML = "Sensibility compute error : sensor_value - tare = 0 !";
            }
        }

        // Prevent NFC reading when browser not visible on the screen
        document.onvisibilitychange = event => {
            if (document.hidden) {
                // All NFC operations are suspended.
                suspendNFC = true;
            } else {
                // All NFC operations can  be resumed.
                suspendNFC = false;
            }
        }
    </script>
</html> 
