<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>NFCReader</title>
        <link rel="stylesheet" href="style.css">
        <!--script src="script.js"></script-->
    </head>
    <body>
        <!-- page content -->
        <header>
            <div id="emse_logo"><img class="emse_logo" src="emse-blanc.png" /></div>
            <div id="page_title">
                <h1>NFC Reader</h1>
                <hr size="1" width="50%" color="white" />
                <h3>Projet téléalimentation capteur capacitif</h3>
            </div>
        </header>

        <div id="body">
            <div id="place_phone_anim">
                <img class="smartphone_tilted" src="smartphone_tilted.png" />
                <img class="antenna_tilted" src="antenna_tilted.png" />
                <button id="scanButton">Requête permission NFC</button>
            </div>

            <div id="tag_comm">
                <p>Lecture en cours...</p>
                <div id="loading_animation">
                    <img id="dot1" src="loading_dot.png" />
                    <img id="dot2" src="loading_dot.png" />
                    <img id="dot3" src="loading_dot.png" />
                    <img id="dot4" src="loading_dot.png" />
                </div>
                
            </div>

            <div id="tag_result">
                <p>Lecture terminée !</p>
                <p id="log">Logger...</p>
                <p id="device_id">Device ID : ...</p>
                <p id="messages">Messages...</p>
            </div>
        </div>

        <footer>Page créée pour des besoins de démonstration - Projet d'étude EMSE ISMIN 2022 - Pierre Merrien & Hugo Perrin</footer>
    </body>
    <script>
        // Initial hide all but placement animation
        document.getElementById("place_phone_anim").hidden = false;
        document.getElementById("tag_comm").hidden = true;
        document.getElementById("tag_result").hidden = true;

        let suspendNFC = false;
        let allowedNFC = false;

        // Handle NFC permission
        navigator.permissions.query({ name: "nfc" }).then((nfcStatus) => {
            if (nfcStatus.state === "granted") {
                allowedNFC = true;
                console.log("NFC Permission already granted");
                document.getElementById("scanButton").hidden = true;

                sampleM24();
            } else {
                console.log("NFC Permission required");
                document.getElementById("scanButton").hidden = false;
                document.querySelector("#scanButton").onclick = event => {
                    scanOnce();
                };
                document.querySelector("#scanButton").onclick = event => {}; // no need to continue button use
            }
        });

        async function scanOnce() {
            const ndef = new NDEFReader();

            await ndef.scan({ /**/ }); // Should ask permission in browser if not already allowed NFC
            
            // Check browser permission status again, to check user answer
            navigator.permissions.query({ name: "nfc" }).then((nfcStatus) => {
                if (nfcStatus.state === "granted") {
                    console.log("NFC Permission now granted");
                    document.getElementById("scanButton").hidden = true;
                    allowedNFC = true;

                    sampleM24();
                } else {
                    console.log("NFC Permission not granted");
                    allowedNFC = false;
                }
            });
        }

        async function sampleM24() {
            while(allowedNFC == false || suspendNFC == true) {/*wait*/}
            
            const ndef = new NDEFReader();

            var m24reg0 = 0x0;
            var m24reg1 = 0x0;

            ndef.onreading = event => {
                // Successful scan

                // Show progress animation while getting correct m24 reading
                document.getElementById("place_phone_anim").hidden = true;
                document.getElementById("tag_comm").hidden = false;
                document.getElementById("tag_result").hidden = true;

                // handle capacitive sensor sample reception
                const message = event.message;
                // at least 2 ndef messages
                if(message.records.length >= 2) {
                    m24reg0 = 0;
                    m24reg1 = 0;
                    // reg0
                    for( let i = 0 ; i < message.records[0].data.buffer.byteLength ; i++) {
                        m24reg0 = m24reg0 << 8 + message.records[0].data.getInt8(i);
                    }
                    // reg1
                    for( let i = 0 ; i < message.records[1].data.buffer.byteLength ; i++) {
                        m24reg1 = m24reg1 << 8 + message.records[1].data.getInt8(i);
                    }
                }
            }

            while(m24reg1 & 0xF == 0) {
                if(allowedNFC == true && suspendNFC == false) {
                    await ndef.scan();
                }
            }

            ndef.onreading = event => {/*empty*/}

            // correct sensor message was sent by m24, showing result
            handleResults(event);
        }

        document.onvisibilitychange = event => {
            if (document.hidden) {
                // All NFC operations are suspended.
                suspendNFC = true;
            } else {
                // All NFC operations can  be resumed.
                suspendNFC = false;
            }
        }
    </script>
</html> 
