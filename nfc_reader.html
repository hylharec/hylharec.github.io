<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>NFCReader</title>
        <link rel="stylesheet" href="PE_webapp/style.css">
        <!--script src="script.js"></script-->
    </head>
    <body>
        <!-- page content -->
        <header>
            <div id="emse_logo"><img src="PE_webapp/emse-blanc.png" height="150px" /></div>
            <div id="page_title">
                <h1>NFC Reader</h1>
                <hr size="1" width="50%" color="white" />
                <h3>Projet téléalimentation capteur capacitif</h3>
            </div>
            <hr id="header_line" size="4" width="90%" color="white" />
        </header>

        <div id="body">
            <div id="place_phone_anim">
                <img class="smartphone_tilted" src="PE_webapp/smartphone_tilted.png" />
                <img class="antenna_tilted" src="PE_webapp/antenna_tilted.png" />
                <button id="scanButton">Query NFC Permission</button>
            </div>

            <div id="tag_comm">
                <p>Lecture en cours...</p>
                
                
            </div>

            <div>
                <p>Lecture terminée !</p>
                <p id="log">Logger...</p>
                <p id="device_id">Device ID : ...</p>
                <p id="messages">Messages...</p>
            </div>
        </div>

        <hr id="footer_line" size="4" width="90%" color="white" />

        <footer>Page créée pour des besoins de démonstration - Projet d'étude EMSE ISMIN 2022 - Pierre Merrien & Hugo Perrin</footer>
    </body>
    <script>
        let suspendNFC = false;

        if ('NDEFReader' in window) {

            navigator.permissions.query({ name: "nfc" }).then((nfcStatus) => {

                if (nfcStatus.state === "granted") {
                    startScanning();
                } else {

                document.querySelector("#scanButton").onclick = event => {
                    startScanning();
                };

                }

            });

            function startScanning(){
                const ndef = new NDEFReader();

                
                ndef.scan().then(() => {

                ndef.onreadingerror = () => {
                    // Could not scan a tag, try another
                    document.getElementById("log").innerHTML = "Tag read error !";
                };

                ndef.onreading = event => {
                    //Scanned a tag successfully
                    if (suspendNFC == true) {
                        document.getElementById("log").innerHTML = "Can only scan when page visible !";    
                    } else {
                        document.getElementById("log").innerHTML = "Scanned successfully !";

                        document.getElementById("messages").innerHTML = "";

                        document.getElementById("device_id").innerHTML = "Device ID : " + event.serialNumber;

                        // =====================================================================================================================
                        // ===================================== DEAL WITH THE MESSAGES RECEIVED FROM THE TAG ==================================
                        const message = event.message;
                        for (const record of message.records) {

                            // Write read messages on the html page

                            document.getElementById("messages").innerHTML += "</br>" + record.data + " ; " + record.data.byteLength + "</br>";
                            
                            // Write plaintext ASCII message
                            for( let i = 0 ; i < record.data.buffer.byteLength ; i++) {
                                document.getElementById("messages").innerHTML += String.fromCharCode(record.data.getInt8(i));
                            }

                            document.getElementById("messages").innerHTML += " : ";

                            // Write hex 
                            for( let i = 0 ; i < record.data.buffer.byteLength ; i++) {
                                document.getElementById("messages").innerHTML += record.data.getInt8(i).toString(16) + " ";
                            }

                            console.log("Record type:  " + record.recordType);
                            console.log("MIME type:    " + record.mediaType);
                            console.log("Record id:    " + record.id);
                            switch (record.recordType) {
                            case "text":
                                // TODO: Read text record with record data, lang, and encoding.
                                break;
                            case "url":
                                // TODO: Read URL record with record data.
                                break;
                            default:
                                // TODO: Handle other records with record data.
                            }
                        }
                        // =====================================================================================================================
                        // =====================================================================================================================
                    }
                };

                }).catch(error => {
                /// Something wrong with hardware
                document.getElementById("log").innerHTML = "Hardware error !";
                });
            }
        }

        document.onvisibilitychange = event => {
            if (document.hidden) {
                // All NFC operations are suspended.
                suspendNFC = true;
            } else {
                // All NFC operations can  be resumed.
                suspendNFC = false;
            }
        }
    </script>
</html> 
